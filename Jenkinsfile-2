pipeline {
  agent { label 'docker-gradle8-jdk21-corretto' }
  options {
    buildDiscarder(logRotator(numToKeepStr: '5'))
  }
  environment {
    SONAR_PROJECT_KEY='Springboot-Demo'
  }
  stages {
    stage('Scan') {
      steps {
        withSonarQubeEnv(installationName: 'sonarqube-server1') { 
          script {
            sh 'chmod +x gradlew'
            sh "./gradlew clean build sonar -Dsonar.projectKey=${env.SONAR_PROJECT_KEY}"
            def sonarUrl = "${env.SONAR_HOST_URL}/dashboard?id=${env.SONAR_PROJECT_KEY}"
            echo "SonarQube Dashboard: ${sonarUrl}"
          }

        }
      }
    }
    // you need to set a url endwith sonarqube-webhook in Administration -> Configuration -> Webhooks 
    // to get the build status back to Jenkins
    // secret is not required
    //Example: http://your-jenkins-server:port/sonarqube-webhook/
    stage("Quality Gate") {
      steps {
        timeout(time: 10, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }
  }
}